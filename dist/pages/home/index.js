"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var a=t[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,o,a){return o&&e(t.prototype,o),a&&e(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_http=require("./../../http.js"),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_util=require("./../../util.js"),_banner=require("./../../components/banner.js"),_banner2=_interopRequireDefault(_banner),_actionSheet=require("./../../components/actionSheet.js"),_actionSheet2=_interopRequireDefault(_actionSheet),_jobFairList=require("./../../components/jobFairList.js"),_jobFairList2=_interopRequireDefault(_jobFairList),_wepyRedux=require("./../../npm/wepy-redux/lib/index.js"),_user=require("./../../store/actions/user.js"),_contant=require("./../../store/actions/contant.js"),_mlvbliveroomcore=require("./../../lib/mlvbliveroomcore.js");console.log(_mlvbliveroomcore.login);var store=(0,_wepyRedux.getStore)(),teamView=function(e){function t(){var e,o,a,i;_classCallCheck(this,t);for(var n=arguments.length,r=Array(n),s=0;s<n;s++)r[s]=arguments[s];return o=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),a.$repeat={},a.$props={jobFairList:{"xmlns:v-bind":"","v-bind:list.sync":"list","v-bind:usertype.sync":"usertype",bindrouterHall:"routerHall",bindbooking:"booking"},actionSheet:{"v-bind:isScaleModal.sync":"isScaleModal","v-bind:text.sync":"text","v-bind:okText.sync":"okText",bindhandleClose:"handleClose",bindhandleOk:"handleOk"}},a.$events={},a.components={banner:_banner2.default,jobFairList:_jobFairList2.default,actionSheet:_actionSheet2.default},a.data={rendaUserTeamType:0,params:{uid:"",page:1,limit:10,status:""},list:[],isScaleModal:!0,count:0,activeIndex:0,statusList:["全部","进行中","待举办"],openid:"",uid:"",usertype:0,TIM:null,text:"",okText:"",userSig:"",roomList:[],isGetLoginInfo:!1,firstshow:!0},a.config={navigationBarTitleText:"首页",enablePullDownRefresh:!0},a.events={searchValue:function(e){a.params=Object.assign(a.params,{keywords:e}),a.getJobfairList()},handleClose:function(){wx.showTabBar(),a.isScaleModal=!a.isScaleModal,a.$apply()},handleOk:function(){wx.getStorageSync("rendaPerfect")?(0,_util.contactPhone)():(0,_util.wxNavigateTo)("/pages/my/companyForm"),wx.showTabBar(),a.isScaleModal=!a.isScaleModal,a.$apply()},booking:function(e){if(console.log(e),!wx.getStorageSync("rendaPerfect"))return wx.hideTabBar(),a.okText="完善信息",a.text="企业信息不完整，请前往完善",a.isScaleModal=!a.isScaleModal,void a.$apply();e.applyinfo||1==e.is_finish||a.addjobfair(e),wx.setStorageSync("addjobfair",JSON.stringify(e.applyinfo))},routerHall:function(e){a.usertype?(a.addjfUser(e.id),wx.setStorageSync("rendaJHID",e.id),wx.setStorageSync("addjobfair",JSON.stringify(e.applyinfo)),(0,_util.wxNavigateTo)("/pages/home/hall?query="+e.id)):(wx.hideTabBar(),a.isScaleModal=!a.isScaleModal,a.$apply())}},a.methods={viewImg:function(e){wx.previewImage({current:e,urls:this.pdfList})},viewLecture:function(){this.params.uid,this.usertype,wx.getStorageSync("rendaPerfect");(0,_util.wxNavigateTo)("/pages/lecture/list")},viewInfo:function(e){(0,_util.wxNavigateTo)(e.url)},viewDetail:function(e){(0,_util.wxNavigateTo)("/pages/companyView/viewJob?query="+e.id+"&apply=1")},searchScrollLower:function(){this.count>this.list.length&&this.count>this.params.limit&&(this.params.limit=this.params.limit+10,this.getJobfairList())},showModal:function(e){this.activeIndex=e,this.params.status=0==e?"":1==e?e:0,this.getJobfairList()}},i=o,_possibleConstructorReturn(a,i)}return _inherits(t,e),_createClass(t,[{key:"videoInit",value:function(){var e=this,t=((new Date).getTime().toString(16),this.userSig),o={sdkAppID:1400335565,userID:this.params.uid,userSig:t,userName:"呵呵的杨大萌",userAvatar:""};(0,_mlvbliveroomcore.login)({data:o,success:function(t){e.firstshow=!1,e.isGetLoginInfo=!0,e.$apply(),e.getRoom()},fail:function(t){e.isGetLoginInfo=!1,e.$apply(),wx.showModal({title:"提示",content:t.errMsg,showCancel:!1,complete:function(){wx.navigateBack({})}})}})}},{key:"getRoom",value:function(){var e=this;if(!e.isGetLoginInfo)return void wx.showModal({title:"提示",content:"登录信息初始化中，请稍后再试",showCancel:!1});(0,_mlvbliveroomcore.getRoomList)({data:{index:0,cnt:20},success:function(t){e.roomList=t.rooms,console.log(this.roomList),e.$apply(),console.log("获取房间列表成功")},fail:function(e){console.log(e),wx.showModal({title:"获取房间列表失败",content:e.errMsg,showCancel:!1})}})}},{key:"addjobfair",value:function(e){var t=this,o={uid:this.params.uid,jf_id:e.id};(0,_http.$http)("/Jobfair/addjobfair",o).then(function(o){o.data?(t.getJobfairList(),1==e.is_audit?(t.text="企业订展正在审核中，请联系客服021-51991869",t.isScaleModal=!t.isScaleModal,t.okText="联系客服",t.$apply()):(0,_util.wxToast)("申请订展成功")):(0,_util.wxToast)("申请订展失败")})}},{key:"addjfUser",value:function(e){var t={uid:this.params.uid,jf_id:e};(0,_http.$http)("/Jobfair/addjf_user",t).then(function(e){console.log(e)})}},{key:"checkUserLogin",value:function(e){var t=this;store.dispatch((0,_user.getAllUser)({openid:e})).then(function(e){e.payload.usertype?(t.params.uid=e.payload.id,t.usertype=e.payload.usertype,t.$parent.globalData.rendaUserType=e.payload.usertype,store.dispatch((0,_user.getUser)({uid:t.params.uid},t.usertype)),t.$apply(),t.getJobfairList(),t.getUserSig()):(wx.clearStorageSync(),(0,_util.wxToast)("请授权登录"),(0,_util.wxNavigateTo)("/pages/login/welcome"))}).catch(function(e){})}},{key:"getJobfairList",value:function(){var e=this;(0,_http.$http)("/Jobfair/getJobfairList",this.params).then(function(t){var o=[];o=t.data.data?t.data.data:[],o.forEach(function(e){e.endtime=_moment2.default.unix(e.endtime).format("YYYY-MM-DD HH:ss"),e.starttime=_moment2.default.unix(e.starttime).format("YYYY-MM-DD HH:ss")}),e.list=o,e.count=t.data.count,e.$apply()})}},{key:"_initIM",value:function(){wx.$app.off(this.TIM.EVENT.SDK_READY,this._onIMReady),wx.$app.off(this.TIM.EVENT.ERROR,this._onIMError),wx.$app.on(this.TIM.EVENT.SDK_READY,this._onIMReady,this),wx.$app.on(this.TIM.EVENT.ERROR,this._onIMError,this)}},{key:"_onIMError",value:function(e){e.data.message&&e.data.code&&2800!==e.data.code&&2999!==e.data.code&&(0,_util.wxToast)(e.data.message)}},{key:"getUserSig",value:function(){var e=this;(0,_http.$http)("/autograph/getAutograph",{uid:this.params.uid+""}).then(function(t){e.userSig=t.data,e.videoInit(),wx.$app.login({userID:e.params.uid+"",userSig:t.data}).then(function(t){e._initIM(),console.log("登录成功"),!0===t.data.repeatLogin&&console.log(t.data.errorInfo)}).catch(function(e){console.warn("login error:",e)})})}},{key:"getConversationProfile",value:function(){var e=this,t="C2C"+this.params.uid;wx.$app.getConversationProfile(t).then(function(t){var o=t.data.conversation.userProfile;console.log(o),wx.setStorageSync("userProfile",JSON.stringify(o)),console.log("获取个人信息"),e.$apply()}).catch(function(e){console.warn("getConversationProfile error:",e)})}},{key:"updateMyProfile",value:function(){var e=wx.getStorageSync("wxInfo")?JSON.parse(wx.getStorageSync("wxInfo")):{};wx.$app.updateMyProfile(e).then(function(e){wx.setStorageSync("userProfile",JSON.stringify(e.data)),console.log(e.data),console.log("更新个人信息")}).catch(function(e){console.warn("updateMyProfile error:",e)})}},{key:"_onIMReady",value:function(){console.log(wx.getStorageSync("wxInfo")),wx.getStorageSync("wxInfo")?this.updateMyProfile():this.getConversationProfile()}},{key:"getOpenId",value:function(){var e=this;wx.login({success:function(t){t.code?(0,_http.$http)("/Login/getopenid",{code:t.code}).then(function(t){var o=JSON.parse(t.data);e.openid=o.openid||"",e.openid?(e.$parent.globalData.openId=o.openid,e.$parent.globalData.sessionKey=o.session_key,wx.setStorageSync("session_key",o.session_key),wx.setStorageSync("rendaOpenId",o.openid),e.checkUserLogin(e.openid)):(wx.clearStorageSync(),(0,_util.wxToast)("请授权登录"),wx.redirectTo({url:"/pages/login/welcome"}))}).catch(function(e){console.log(e)}):console.log("获取失败！"+t.errMsg)}})}},{key:"bindrefresherrefresh",value:function(){this.onShow()}},{key:"onShow",value:function(){wx.showTabBar(),this.TIM=this.$parent.globalData.TIM,wx.getStorageSync("rendaOpenId")&&wx.getStorageSync("session_key")?(this.openid=wx.getStorageSync("rendaOpenId"),this.checkUserLogin(this.openid)):this.getOpenId(),store.dispatch((0,_contant.getAllContant)())}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(teamView,"pages/home/index"));