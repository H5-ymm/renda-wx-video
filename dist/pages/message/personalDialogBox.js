"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_class,_temp2,_initialiseProps,_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_http=require("./../../http.js"),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_noticeModal=require("./../../components/noticeModal.js"),_noticeModal2=_interopRequireDefault(_noticeModal),_modal=require("./../../components/modal.js"),_modal2=_interopRequireDefault(_modal),_util=require("./../../util.js"),_timWxSdk=require("./../../npm/tim-wx-sdk/tim-wx.js"),_timWxSdk2=_interopRequireDefault(_timWxSdk),_cosWxSdkV=require("./../../npm/cos-wx-sdk-v5/demo/lib/cos-wx-sdk-v5.js"),_cosWxSdkV2=_interopRequireDefault(_cosWxSdkV),tim=_timWxSdk2.default.create({SDKAppID:1400335565});tim.setLogLevel(0),tim.registerPlugin({"cos-wx-sdk":_cosWxSdkV2.default});var personalDialogBox=(_temp2=_class=function(e){function t(){var e,o,i,s;_classCallCheck(this,t);for(var n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),_initialiseProps.call(i),s=o,_possibleConstructorReturn(i,s)}return _inherits(t,e),_createClass(t,[{key:"onPullDownRefresh",value:function(){this.getMessage()}},{key:"onLoad",value:function(e){this.params.uid=e.userID,this.uid=wx.getStorageSync("rendaUid")||this.$parent.globalData.uid,e.toUser?(this.toUserId=e.toUser,this.conversationID="C2C"+this.toUserId,this.getUserSig()):(this.conversationID=e.query,this.isLogin=e.isLogin,this.toUserId=e.userID,this.getMessage()),this.userInfo=wx.getStorageSync("userInfo")?JSON.parse(wx.getStorageSync("userInfo")):{},this.rendaUserType=wx.getStorageSync("rendaUserType"),this.$apply(),1==this.rendaUserType?this.getCommunicate():this.getPersonal()}},{key:"scrollToBottom",value:function(){if(this.isClear){console.log(222);wx.createSelectorQuery().select("#chat").boundingClientRect(function(e){wx.pageScrollTo({scrollTop:99999})}).exec()}}},{key:"onShow",value:function(){var e=this;this.isClear=!0,this.$apply(),tim.on(_timWxSdk2.default.EVENT.MESSAGE_RECEIVED,function(t){console.log(t.data),wx.createSelectorQuery().select("#chat").boundingClientRect(function(t){t.bottom-e.height<150&&e.scrollToBottom()}).exec();var o=setInterval(function(){0!==e.messageList.length&&(e.scrollToBottom(),clearInterval(o))},600),i=[];t.data.forEach(function(t){if("TIMCustomElem"==t.type){var o=JSON.stringify(t._elements[0].content);console.log(o);var s="/pages/room/room?args="+o+"&from="+t.from+"&to="+t.to+"&uid="+e.uid;wx.navigateTo({url:s})}else{var n={to:t.to,from:t.from,text:t._elements[0].content.text,time:_moment2.default.unix(t.time).format("YYYY-MM-DD HH:mm")};i.push(n)}e.messageList=e.messageList.concat(i),e.$apply()})})}},{key:"onUnload",value:function(){this.isClear=!1}},{key:"onReachBottom",value:function(){}},{key:"getPersonal",value:function(){var e=this,t={com_id:this.params.uid,uid:this.uid};(0,_http.$http)("/autograph/CommunicateImmediately_personal",t).then(function(t){e.is_apply="",e.$apply()})}},{key:"getCommunicate",value:function(){var e=this,t={apply_uid:this.toUserId,uid:this.params.uid};(0,_http.$http)("/autograph/CommunicateImmediately_company",t).then(function(t){e.is_apply=t.data.is_apply,e.isEntry=t.data.is_entrymsg,e.$apply()})}},{key:"getNewList",value:function(e){var t={},o=void 0;return e.map(function(e){var i=e.payload,s=e.to,n=e.from,a=e.time,r=a;return r=_moment2.default.unix(r).format("YYYY-MM-DD HH:mm"),i.imageInfoArray&&i.imageInfoArray.length?(o=i.imageInfoArray[0].imageUrl,t=Object.assign({to:s,from:n,img:o,text:"",time:r})):t=Object.assign(i,{to:s,from:n,time:r}),t})}},{key:"getMessage",value:function(e){var t=this,o={conversationID:this.conversationID,count:15};e&&(o.nextReqMessageID=e),tim.getMessageList(o).then(function(e){var o=e.data.messageList;t.messageList=t.getNewList(o),t.nextReqMessageID=e.data.nextReqMessageID,t.isCompleted=e.data.isCompleted,t.scrollToBottom(),t.$apply(),t.getConversationProfile()}).catch(function(e){console.warn("messageList error:",e)})}},{key:"getUserSig",value:function(){var e=this;(0,_http.$http)("/autograph/getAutograph",{uid:this.uid}).then(function(t){tim.login({userID:e.uid+"",userSig:t.data}).then(function(t){e.setSdkReady?e.getMessageList():e.getMsgDetail(),!0===t.data.repeatLogin&&(console.log("登录成功"),e.getMessage())}).catch(function(e){console.warn("login error:",e)})})}},{key:"getMsgDetail",value:function(){var e=this,t=function(t){wx.setStorageSync("setSdkReady",!0),e.getMessage()};tim.on(_timWxSdk2.default.EVENT.SDK_READY,t)}},{key:"getConversationProfile",value:function(){var e=this;this.uid;tim.getConversationProfile(this.conversationID).then(function(t){var o=t.data.conversation.userProfile;e.userProfile=o,e.$apply()}).catch(function(e){console.warn("getConversationProfile error:",e)})}},{key:"routerView",value:function(e){var t="/pages/room/room?roomID="+e.room_num+"&userSig="+e.userSig+"&template=grid&debugMode=false&cloudenv=PRO&localVideo=true&localAudio=true&enableEarMonitor=false&enableAutoFocus=true&localMirror=auto&enableAgc=true&enableAns=true&encsmall=true&frontCamera=front&videoWidth=360&videoHeight=640&scene=rtc&userID="+e.room_name+"&minBitrate=600&maxBitrate=900";wx.navigateTo({url:t})}},{key:"getRandomInt",value:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}},{key:"entryUser",value:function(e){var t=this;(0,_http.$http)("/Autograph/entry",e).then(function(o){if(o.data){var i="入职通知"+_moment2.default.unix(e.entry_time).format("YYYY-MM-DD HH:mm")+e.entry_address+e.content;t.sendMessageApi(i),t.isNoticeModal=!t.isNoticeModal,t.$apply()}})}},{key:"sendMessageApi",value:function(e){var t=this,o=tim.createTextMessage({to:this.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{text:e}});tim.sendMessage(o).then(function(o){console.log("发送成功");var i={to:t.toUserId,from:t.uid,text:e,time:(0,_moment2.default)().format("YYYY-MM-DD HH:mm")};t.messageList.push(i),t.scrollToBottom(),t.message="",t.$apply()}).catch(function(e){console.warn("sendMessage error:",e)})}}]),t}(_wepy2.default.page),_initialiseProps=function(){var e=this;this.$repeat={},this.$props={noticeModal:{"xmlns:v-bind":"","v-bind:isScaleModal.sync":"isNoticeModal",bindsetAllTime:"setAllTime"},modal:{"v-bind:isScaleModal.sync":"isModal","v-bind:modalObj.sync":"modalObj",bindhandleClose:"handleClose",bindhandleOk:"handleOk"}},this.$events={},this.components={noticeModal:_noticeModal2.default,modal:_modal2.default},this.data={params:{uid:"",id:""},list:[],count:0,isView:!1,id:"",isLogin:!1,conversationID:"",toUserId:"",userProfile:{},setSdkReady:!1,messageList:[],uid:"",rendaUserType:"",is_apply:"",isNoticeModal:!0,isModal:!0,modalObj:{title:"不合适",subTitle:"请输入不合适理由"},isEntry:"",userInfo:{},message:"",isShow:!1,isCompleted:!0,nextReqMessageID:"",height:0,isClear:!1,scrollTop:100},this.config={navigationBarTitleText:"消息",enablePullDownRefresh:!0},this.events={setAllTime:function(t){console.log(t);var o=Object.assign({apply_uid:e.toUserId,uid:e.params.uid},t);e.entryUser(o)},handleOk:function(t){var o="不合适"+t;e.sendMessageApi(o)},handleClose:function(){e.isModal=!e.isModal,e.$apply()}},this.methods={noticeEntry:function(){this.isNoticeModal=!this.isNoticeModal,this.$apply()},handleImproper:function(){this.isModal=!this.isModal,this.$apply()},inputBind:function(e){if(this.message=e.detail.value,!this.message)return(0,_util.wxToast)("消息不能为空");this.sendMessageApi(this.message)},blurInput:function(e){console.log(e),this.message="",this.$apply()},showMessageBtn:function(){this.isShow=!this.isShow,this.$apply()},uploadImage:function(){var e=this;wx.chooseImage({sourceType:["album"],count:1,success:function(t){var o=tim.createImageMessage({to:e.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{file:t},onProgress:function(e){console.log("file uploading:",e)}});console.log(t),tim.sendMessage(o).then(function(o){var i={to:e.toUserId,from:e.uid,text:"",img:t.tempFilePaths[0],time:(0,_moment2.default)().format("YYYY-MM-DD HH:mm")};e.messageList.push(i),e.scrollToBottom(),console.log(o)}).catch(function(e){console.warn("sendMessage error:",e)})}})},viewImage:function(e){wx.previewImage({current:e.img,urls:[e.img]})},videoCall:function(){var e=this,t={call_id:"",version:3,room_id:this.getRandomInt(0,42949),action:0,duration:0,invited_list:[]},o=JSON.stringify(t),i=tim.createCustomMessage({to:this.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{data:o,description:"",extension:""}});tim.sendMessage(i).then(function(t){e.getMessage(),console.log(t)}).catch(function(e){console.warn("sendMessage error:",e)});var s="/pages/room/room?args="+o+"&from="+this.uid+"&to="+this.toUserId+"&uid="+this.uid;wx.navigateTo({url:s})},viewResume:function(){console.log(this.toUserId),(0,_util.wxNavigateTo)("/pages/my/resume?query="+this.toUserId)}}},_temp2);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(personalDialogBox,"pages/message/personalDialogBox"));