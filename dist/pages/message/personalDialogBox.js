"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_class,_temp2,_initialiseProps,_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_http=require("./../../http.js"),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_util=require("./../../util.js"),_timWxSdk=require("./../../npm/tim-wx-sdk/tim-wx.js"),_timWxSdk2=_interopRequireDefault(_timWxSdk),_cosWxSdkV=require("./../../npm/cos-wx-sdk-v5/demo/lib/cos-wx-sdk-v5.js"),_cosWxSdkV2=_interopRequireDefault(_cosWxSdkV),tim=_timWxSdk2.default.create({SDKAppID:1400335565});tim.setLogLevel(0),tim.registerPlugin({"cos-wx-sdk":_cosWxSdkV2.default});var personalDialogBox=(_temp2=_class=function(e){function t(){var e,o,i,n;_classCallCheck(this,t);for(var s=arguments.length,a=Array(s),r=0;r<s;r++)a[r]=arguments[r];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),_initialiseProps.call(i),n=o,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"onLoad",value:function(e){this.params.uid=e.userID,this.uid=wx.getStorageSync("rendaUid")||this.$parent.globalData.uid,e.toUser?(this.toUserId=e.toUser,this.conversationID="C2C"+this.toUserId,this.getUserSig()):(this.conversationID=e.query,this.isLogin=e.isLogin,this.getMessage())}},{key:"onShow",value:function(){wx.getStorageSync("isView")?this.isView=!0:this.isView=!1,this.$apply()}},{key:"getMessage",value:function(){var e=this;tim.getMessageList({conversationID:this.conversationID,count:15}).then(function(t){var o=t.data.messageList,i={},n=void 0,s=o.map(function(e){var t=e.payload,o=e.to,s=e.from;return t.imageInfoArray&&t.imageInfoArray.length?(n=t.imageInfoArray[0].imageUrl,i=Object.assign({to:o,from:s,img:n,text:""})):i=Object.assign(t,{to:o,from:s}),i});e.messageList=s,console.log(s),e.$apply(),e.getConversationProfile(),t.data.nextReqMessageID,t.data.isCompleted}).catch(function(e){console.log(e),console.warn("messageList error:",e)})}},{key:"getUserSig",value:function(){var e=this;(0,_http.$http)("/autograph/getAutograph",{uid:this.params.uid}).then(function(t){tim.login({userID:e.params.uid+"",userSig:t.data}).then(function(t){e.setSdkReady?e.getMessageList():e.getMsgDetail(),!0===t.data.repeatLogin&&(console.log("登录成功"),e.getMessage())}).catch(function(e){console.warn("login error:",e)})})}},{key:"getMsgDetail",value:function(){var e=this,t=function(t){wx.setStorageSync("setSdkReady",!0),e.getMessage()};tim.on(_timWxSdk2.default.EVENT.SDK_READY,t)}},{key:"getConversationProfile",value:function(){var e=this;tim.getConversationProfile(this.conversationID).then(function(t){var o=t.data.conversation.userProfile;e.userProfile=o,console.log(e.userProfile),e.$apply()}).catch(function(e){console.warn("getConversationProfile error:",e)})}},{key:"routerView",value:function(e){var t="/pages/room/room?roomID="+e.room_num+"&userSig="+e.userSig+"&template=grid&debugMode=false&cloudenv=PRO&localVideo=true&localAudio=true&enableEarMonitor=false&enableAutoFocus=true&localMirror=auto&enableAgc=true&enableAns=true&encsmall=true&frontCamera=front&videoWidth=360&videoHeight=640&scene=rtc&userID="+e.room_name+"&minBitrate=600&maxBitrate=900";wx.navigateTo({url:t})}},{key:"getRandomInt",value:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}}]),t}(_wepy2.default.page),_initialiseProps=function(){this.data={params:{uid:"",id:""},list:[],messageDetail:{view_time:"",logo_url:""},count:0,isView:!1,id:"",isLogin:!1,conversationID:"",toUserId:"",userProfile:{},setSdkReady:!1,messageList:[],uid:""},this.config={navigationBarTitleText:"消息"},this.methods={inputBind:function(e){var t=this,o=e.detail.value,i=this,n=tim.createTextMessage({to:i.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{text:o}});tim.sendMessage(n).then(function(e){console.log("发送成功");var n={to:i.toUserId,from:t.params.uid,text:o,type:1};t.messageList.push(n),t.$apply()}).catch(function(e){console.warn("sendMessage error:",e)})},uploadImage:function(){var e=this;wx.chooseImage({sourceType:["album"],count:1,success:function(t){var o=tim.createImageMessage({to:e.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{file:t},onProgress:function(e){console.log("file uploading:",e)}});console.log(t),tim.sendMessage(o).then(function(t){e.getMessage(),console.log(t)}).catch(function(e){console.warn("sendMessage error:",e)})}})},viewImage:function(e){wx.previewImage({current:e.img,urls:[e.img]})},videoCall:function(){var e=this,t={call_id:"",version:3,room_id:this.getRandomInt(0,42949),action:0,duration:0,invited_list:[]},o=JSON.stringify(t),i=tim.createCustomMessage({to:this.toUserId,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{data:o,description:"",extension:""}});tim.sendMessage(i).then(function(t){e.getMessage(),console.log(t)}).catch(function(e){console.warn("sendMessage error:",e)});var n="/pages/room/room?args="+o+"&from="+this.params.uid+"&to="+this.toUserId+"&uid="+this.uid;wx.navigateTo({url:n})},videoView:function(){var e=this,t={room_name:wx.getStorageSync("phone"),room_num:this.messageDetail.room_num};(0,_util.wxShowModal)("视频面试","请确认已与企业电话沟通时间，未沟通可能造成视频面试失败?").then(function(o){e.getuserSig(t)}).catch(function(){console.log("取消")})},viewResume:function(){(0,_util.wxNavigateTo)("/pages/my/resume?query=1")},recommend:function(){wx.navigateTo({url:"/pages/companyView/viewJob?query="+this.messageDetail.job_id+"&room_num="+this.messageDetail.room_num})},concat:function(){var e=this;wx.showActionSheet({itemList:["拨打企业电话"],success:function(t){wx.makePhoneCall({phoneNumber:e.messageDetail.link_tel})},fail:function(e){console.log(e.errMsg)}})}}},_temp2);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(personalDialogBox,"pages/message/personalDialogBox"));