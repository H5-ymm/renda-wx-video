"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var s=t[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,o,s){return o&&e(t.prototype,o),s&&e(t,s),t}}(),_class,_temp2,_initialiseProps,_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_http=require("./../../http.js"),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_noticeModal=require("./../../components/noticeModal.js"),_noticeModal2=_interopRequireDefault(_noticeModal),_modal=require("./../../components/modal.js"),_modal2=_interopRequireDefault(_modal),_util=require("./../../util.js"),personalDialogBox=(_temp2=_class=function(e){function t(){var e,o,s,i;_classCallCheck(this,t);for(var n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];return o=s=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),_initialiseProps.call(s),i=o,_possibleConstructorReturn(s,i)}return _inherits(t,e),_createClass(t,[{key:"onPullDownRefresh",value:function(){this.getMessage()}},{key:"_initIM",value:function(){wx.$app.off(this.TIM.EVENT.SDK_READY,this._onIMMessageReceived),wx.$app.on(this.TIM.EVENT.MESSAGE_RECEIVED,this._onIMMessageReceived,this)}},{key:"onLoad",value:function(e){this.TIM=this.$parent.globalData.TIM,this.params.uid=e.userID,this.uid=wx.getStorageSync("rendaUid")||this.$parent.globalData.uid,this.userInfo=wx.getStorageSync("userInfo")?JSON.parse(wx.getStorageSync("userInfo")):{},this.rendaUserType=wx.getStorageSync("rendaUserType"),this.setSdkReady=wx.getStorageSync("setSdkReady"),this.$apply(),e.toUser?(this.toUserId=e.toUser,this.conversationID="C2C"+this.toUserId):(this.conversationID=e.query,this.toUserId=e.userID),2==this.rendaUserType&&this.getPersonal(),this.getCommunicate(),this.getMessage()}},{key:"scrollToBottom",value:function(){wx.pageScrollTo({scrollTop:99999})}},{key:"onReady",value:function(){var e=this;wx.getSystemInfo({success:function(t){console.log(t.windowHeight),e.windowHeight=t.windowHeight}})}},{key:"_onIMMessageReceived",value:function(e){var t=this;this.scrollToBottom();var o=setInterval(function(){0!==t.messageList.length&&(t.scrollToBottom(),clearInterval(o))},600);e.data.forEach(function(e){if("TIMCustomElem"==e.type){if(0==JSON.parse(e._elements[0].content.data).action){var o={args:e._elements[0].content.data,to:e.to,fromId:e.from,room_id:JSON.parse(e._elements[0].content.data).room_id};t.getuserSig(o)}}else t.getMessage();t.$apply()})}},{key:"onShow",value:function(){this._initIM()}},{key:"onUnload",value:function(){this.isClear=!1}},{key:"onReachBottom",value:function(){}},{key:"getPersonal",value:function(){var e=this,t={com_id:2==this.rendaUserType?this.toUserId:this.uid,uid:2==this.rendaUserType?this.uid:this.toUserId};(0,_http.$http)("/autograph/CommunicateImmediately_personal",t).then(function(t){console.log(t.data),console.log("获取信息"),e.$apply()})}},{key:"getCommunicate",value:function(){var e=this,t={apply_uid:1==this.rendaUserType?this.toUserId:this.uid,uid:1==this.rendaUserType?this.uid:this.toUserId};(0,_http.$http)("/autograph/CommunicateImmediately_company",t).then(function(t){e.is_apply=Number(t.data.is_apply),e.isEntry=Number(t.data.is_entrymsg),1==e.rendaUserType&&(e.userInfo.head_img=t.data.logo_url,e.userInfo.nickname=t.data.nickname),e.$apply()})}},{key:"getNewList",value:function(e){var t={},o=void 0;return e.map(function(e){var s=e.payload,i=e.to,n=e.from,a=e.time,r=e.type,l=a;if(l=_moment2.default.unix(l).format("YYYY-MM-DD HH:mm"),s.imageInfoArray&&s.imageInfoArray.length)o=s.imageInfoArray[0].imageUrl,t=Object.assign({to:i,from:n,img:o,text:"",time:l});else if("TIMCustomElem"==r){var u=JSON.parse(s.data);t=Object.assign(u,{to:i,from:n,time:l})}else t=Object.assign(s,{to:i,from:n,time:l});return t})}},{key:"changeHeight",value:function(){var e=this;wx.createSelectorQuery().select("#scroll").boundingClientRect(function(t){e.scrollHeight="auto",e.$apply()}).exec()}},{key:"getMessage",value:function(){var e=this;this.getConversationProfile();var t={conversationID:this.conversationID,count:15};wx.$app.getMessageList(t).then(function(t){var o=t.data.messageList;o.length?e.changeHeight():e.scrollHeight=e.windowHeight+"px",e.messageList=e.getNewList(o),console.log(e.messageList),e.scrollToBottom(),e.$apply();var s=setInterval(function(){0!==e.messageList.length&&(e.scrollToBottom(),clearInterval(s))},600)}).catch(function(e){console.warn("messageList error:",e)})}},{key:"getUserSig",value:function(){var e=this;(0,_http.$http)("/autograph/getAutograph",{uid:this.uid}).then(function(t){tim.login({userID:e.uid+"",userSig:t.data}).then(function(t){e.setSdkReady?e.getMessage():e.getMsgDetail(),!0===t.data.repeatLogin&&console.log("登录成功")}).catch(function(e){console.warn("login error:",e)})})}},{key:"getConversationProfile",value:function(){var e=this;this.uid;wx.$app.getConversationProfile(this.conversationID).then(function(t){var o=t.data.conversation.userProfile;e.userProfile=o,console.log(e.userProfile),e.$apply()}).catch(function(e){console.warn("getConversationProfile error:",e)})}},{key:"getuserSig",value:function(e){var t=this;(0,_http.$http)("/autograph/getAutograph",{uid:this.uid}).then(function(o){e.userSig=o.data,t.routerView(e)})}},{key:"routerView",value:function(e){console.log(e);var t="/pages/room/room?roomID="+e.room_id+"&userSig="+e.userSig+"&to="+e.to+"&args="+e.args+"&fromId="+e.fromId+"&userID="+this.uid+"&nick="+this.userProfile.nick+"&name="+this.userInfo.nickname;wx.navigateTo({url:t})}},{key:"getRandomInt",value:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}},{key:"entryUser",value:function(e){var t=this;(0,_http.$http)("/Autograph/entry",e).then(function(o){if(o.data){var s="入职通知"+_moment2.default.unix(e.entry_time).format("YYYY-MM-DD HH:mm")+e.entry_address+e.content;t.sendMessageApi(s),t.isNoticeModal=!t.isNoticeModal,t.$apply()}})}},{key:"sendMessageApi",value:function(e){var t=this,o=wx.$app.createTextMessage({to:this.toUserId,conversationType:this.TIM.TYPES.CONV_C2C,payload:{text:e}});wx.$app.sendMessage(o).then(function(o){console.log("发送成功");var s={to:t.toUserId,from:t.uid,text:e,time:(0,_moment2.default)().format("YYYY-MM-DD HH:mm")};t.messageList.push(s),t.scrollToBottom(),t.changeHeight(),t.message="",t.$apply()}).catch(function(e){console.warn("sendMessage error:",e)})}}]),t}(_wepy2.default.page),_initialiseProps=function(){var e=this;this.$repeat={},this.$props={noticeModal:{"xmlns:v-bind":"","v-bind:isScaleModal.sync":"isNoticeModal",bindsetAllTime:"setAllTime"},modal:{"v-bind:isScaleModal.sync":"isModal","v-bind:modalObj.sync":"modalObj",bindhandleClose:"handleClose",bindhandleOk:"handleOk"}},this.$events={},this.components={noticeModal:_noticeModal2.default,modal:_modal2.default},this.data={params:{uid:"",id:""},list:[],count:0,isView:!1,id:"",isLogin:!1,conversationID:"",toUserId:"",userProfile:{},setSdkReady:!1,messageList:[],uid:"",rendaUserType:"",is_apply:"",isNoticeModal:!0,isModal:!0,modalObj:{title:"不合适",subTitle:"请输入不合适理由"},isEntry:"",userInfo:{},message:"",isShow:!1,isCompleted:!0,nextReqMessageID:"",height:0,isClear:!1,scrollTop:100,scrollHeight:"auto",TIM:null,windowHeight:0},this.config={navigationBarTitleText:"消息",enablePullDownRefresh:!0},this.events={setAllTime:function(t){console.log(t);var o=Object.assign({apply_uid:e.toUserId,uid:e.params.uid},t);e.entryUser(o)},handleOk:function(t){var o="不合适"+t;e.sendMessageApi(o)},handleClose:function(){e.isModal=!e.isModal,e.$apply()}},this.methods={noticeEntry:function(){this.isNoticeModal=!this.isNoticeModal,this.$apply()},handleImproper:function(){this.isModal=!this.isModal,this.$apply()},inputBind:function(e){if(this.message=e.detail.value,!this.message)return(0,_util.wxToast)("消息不能为空");this.sendMessageApi(this.message)},blurInput:function(e){console.log(e),this.message="",this.$apply()},showMessageBtn:function(){this.isShow=!this.isShow,this.$apply()},uploadImage:function(){var e=this;wx.chooseImage({sourceType:["album"],count:1,success:function(t){var o=wx.$app.createImageMessage({to:e.toUserId,conversationType:e.TIM.TYPES.CONV_C2C,payload:{file:t},onProgress:function(e){console.log("file uploading:",e)}});console.log(t),wx.$app.sendMessage(o).then(function(o){var s={to:e.toUserId,from:e.uid,text:"",img:t.tempFilePaths[0],time:(0,_moment2.default)().format("YYYY-MM-DD HH:mm")};e.messageList.push(s),e.scrollToBottom(),console.log(o)}).catch(function(e){console.warn("sendMessage error:",e)})}})},viewImage:function(e){wx.previewImage({current:e.img,urls:[e.img]})},videoCall:function(){var e=this,t={call_id:"",version:3,room_id:this.getRandomInt(0,42949),action:0,duration:0,invited_list:[]},o=JSON.stringify(t),s=wx.$app.createCustomMessage({to:this.toUserId,conversationType:this.TIM.TYPES.CONV_C2C,payload:{data:o,description:"",extension:""}});wx.$app.sendMessage(s).then(function(s){var i=Object.assign({args:o,to:e.toUserId,fromId:e.uid,room_id:t.room_id});e.getuserSig(i),console.log(s)}).catch(function(e){console.warn("sendMessage error:",e)})},viewResume:function(){console.log(this.toUserId),(0,_util.wxNavigateTo)("/pages/my/resume?query="+this.toUserId)}}},_temp2);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(personalDialogBox,"pages/message/personalDialogBox"));