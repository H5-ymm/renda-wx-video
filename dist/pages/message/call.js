"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var o=e[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,s,o){return s&&t(e.prototype,s),o&&t(e,o),e}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_http=require("./../../http.js"),_util=require("./../../util.js"),_timWxSdk=require("./../../npm/tim-wx-sdk/tim-wx.js"),_timWxSdk2=_interopRequireDefault(_timWxSdk),_GenerateTestUserSig=require("./../../debug/GenerateTestUserSig.js"),ERROR_OPEN_CAMERA=-4,ERROR_OPEN_MIC=-5,ERROR_PUSH_DISCONNECT=-6,ERROR_CAMERA_MIC_PERMISSION=-7,ERROR_EXCEEDS_THE_MAX_MEMBER=-8,ERROR_REQUEST_ROOM_SIG=-9,ERROR_JOIN_ROOM=-10,call=function(t){function e(){var t,s,o,i;_classCallCheck(this,e);for(var r=arguments.length,n=Array(r),a=0;a<r;a++)n[a]=arguments[a];return s=o=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(n))),o.data={rendaUserTeamType:0,params:{uid:"",com_uid:""},list:[],count:0,isView:!1,com_uid:"",messageDetail:{},args:{},closeFlag:!1,refuseFlag:!1,isPending:!0,isCalling:!1,frontCamera:!1,beauty:0,muted:!1,timeStamp:0,sdkAppID:0,userSig:"",userID:"",roomID:0,type:"",from:"",to:"",timeoutId:"",startTime:0},o.config={navigationBarTitleText:"视频通话",usingComponents:{"webrtc-room":"../../component/webrtc-room/webrtc-room"}},o.methods={onRoomEvent:function(t){if([ERROR_OPEN_CAMERA,ERROR_OPEN_MIC,ERROR_PUSH_DISCONNECT,ERROR_CAMERA_MIC_PERMISSION,ERROR_EXCEEDS_THE_MAX_MEMBER,ERROR_REQUEST_ROOM_SIG,ERROR_JOIN_ROOM].includes(t.target.code)){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.stop(),this.args.action=-2,this.args.code=t.target.code;var e=JSON.stringify(this.args),s=this.to===this.userID?this.from:this.to,o=wx.$app.createCustomMessage({to:s,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",o),wx.$app.sendMessage(o),clearTimeout(this.timeoutId)}"error"===t.target.tag&&wx.showToast({title:t.target.detail,duration:1e3})},handleCloseRoom:function(){this.closeFlag=!0,this.closeRoom(),wx.navigateBack({delta:1})},handleRefuse:function(){this.refuseFlag=!0,this.refuse(),wx.navigateBack({delta:1})},closeRoom:function(){if(this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.stop(),this.args.action=5,0===this.startTime&&(this.args.action=1),0!==this.startTime){var t=(new Date).getTime();this.args.duration=Math.round((t-this.startTime)/1e3),this.startTime=0}var e=JSON.stringify(this.args),s=this.to===this.$store.getters.myInfo.userID?this.from:this.to,o=wx.$app.createCustomMessage({to:s,conversationType:TYPES.CONV_C2C,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",o),wx.$app.sendMessage(o),clearTimeout(this.timeoutId)},timeout:function(){this.args.action=3;var t=JSON.stringify(this.args),e=wx.$app.createCustomMessage({to:this.to,conversationType:TYPES.CONV_C2C,payload:{data:t,description:"",extension:""}});this.$store.commit("sendMessage",e),wx.$app.sendMessage(e),wx.navigateBack({delta:1})},receive:function(){this.args.action=4;var t=JSON.stringify(this.args);this.startTime=(new Date).getTime();var e=wx.$app.createCustomMessage({to:this.from,conversationType:TYPES.CONV_C2C,payload:{data:t,description:"",extension:""}});this.$store.commit("sendMessage",e),wx.$app.sendMessage(e),clearTimeout(this.timeoutId),this.isCalling=!0,this.isPending=!1,this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.start()},onCall:function(){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.start()},refuse:function(){this.args.action=2;var t=JSON.stringify(this.args),e=wx.$app.createCustomMessage({to:this.from,conversationType:TYPES.CONV_C2C,payload:{data:t,description:"",extension:""}});this.$store.commit("sendMessage",e),this.$store.commit("setCalling",!1),wx.$app.sendMessage(e),clearTimeout(this.timeoutId)},alreadyCalling:function(t){var e=JSON.parse(t.payload.data);e.action=6;var s=wx.$app.createCustomMessage({to:t.from,conversationType:TYPES.CONV_C2C,payload:{data:JSON.stringify(e),description:"",extension:""}});this.$store.commit("sendMessage",s),wx.$app.sendMessage(s)},microphone:function(){this.muted=!this.muted},monitor:function(){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.switchCamera()}},i=s,_possibleConstructorReturn(o,i)}return _inherits(e,t),_createClass(e,[{key:"onShow",value:function(){var t=this,e=(0,_GenerateTestUserSig.genTestUserSig)(this.userID);this.userSig=e.userSig,this.sdkAppID=e.sdkappid,this.isCalling=!1,this.isPending=!0,this.userID===this.from&&(this.timeoutId=setTimeout(function(){t.timeout()},6e4)),wx.setKeepScreenOn({keepScreenOn:!0}),this.$store.commit("setCalling",!0)}},{key:"onUnload",value:function(){this.refuseFlag||this.closeFlag||(this.isCalling?this.closeRoom():"call"===this.type?this.closeRoom():this.refuse()),this.refuseFlag=!1,this.closeFlag=!1,this.isCalling=!1,this.isPending=!1,clearTimeout(this.timeoutId),this.$store.commit("setCalling",!1)}},{key:"onHide",value:function(){this.isCalling=!1,this.isPending=!1,clearTimeout(this.timeoutId),this.closeRoom(),this.$store.commit("setCalling",!1),this.$bus.$off("onCall"),this.$bus.$off("isCalling"),this.$bus.$off("onClose"),this.$bus.$off("onRefuse"),this.$bus.$off("onBusy")}},{key:"onLoad",value:function(t){console.log(t),this.args=JSON.parse(t.args),this.userID=wx.getStorageSync("rendaUid")||this.$parent.globalData.uid,this.from=t.from,this.to=t.to,this.type=this.userID===this.from?"call":"onCall",this.roomID=this.args.room_id}},{key:"destory",value:function(){}}]),e}(_wepy2.default.page);exports.default=call;