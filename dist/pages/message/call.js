"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var o=t[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,s,o){return s&&e(t.prototype,s),o&&e(t,o),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_http=require("./../../http.js"),_util=require("./../../util.js"),_timWxSdk=require("./../../npm/tim-wx-sdk/tim-wx.js"),_timWxSdk2=_interopRequireDefault(_timWxSdk),_GenerateTestUserSig=require("./../../debug/GenerateTestUserSig.js"),ERROR_OPEN_CAMERA=-4,ERROR_OPEN_MIC=-5,ERROR_PUSH_DISCONNECT=-6,ERROR_CAMERA_MIC_PERMISSION=-7,ERROR_EXCEEDS_THE_MAX_MEMBER=-8,ERROR_REQUEST_ROOM_SIG=-9,ERROR_JOIN_ROOM=-10,call=function(e){function t(){var e,s,o,i;_classCallCheck(this,t);for(var r=arguments.length,n=Array(r),a=0;a<r;a++)n[a]=arguments[a];return s=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),o.data={rendaUserTeamType:0,params:{uid:"",com_uid:""},list:[],count:0,isView:!1,com_uid:"",messageDetail:{},args:{},closeFlag:!1,refuseFlag:!1,isPending:!0,isCalling:!1,frontCamera:!1,beauty:0,muted:!1,timeStamp:0,sdkAppID:0,userSig:"",userID:"",roomID:0,type:"",from:"",to:"",timeoutId:"",startTime:0},o.config={navigationBarTitleText:"视频通话",usingComponents:{"webrtc-room":"../../component/webrtc-room/webrtc-room"}},o.methods={onRoomEvent:function(e){if([ERROR_OPEN_CAMERA,ERROR_OPEN_MIC,ERROR_PUSH_DISCONNECT,ERROR_CAMERA_MIC_PERMISSION,ERROR_EXCEEDS_THE_MAX_MEMBER,ERROR_REQUEST_ROOM_SIG,ERROR_JOIN_ROOM].includes(e.target.code)){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.stop(),this.args.action=-2,this.args.code=e.target.code;var t=JSON.stringify(this.args),s=this.to===this.userID?this.from:this.to,o=wx.$app.createCustomMessage({to:s,conversationType:_timWxSdk2.default.TYPES.CONV_C2C,payload:{data:t,description:"",extension:""}});this.$store.commit("sendMessage",o),wx.$app.sendMessage(o),clearTimeout(this.timeoutId)}"error"===e.target.tag&&wx.showToast({title:e.target.detail,duration:1e3})},handleCloseRoom:function(){this.closeFlag=!0,this.closeRoom(),wx.navigateBack({delta:1})},handleRefuse:function(){this.refuseFlag=!0,this.refuse(),wx.navigateBack({delta:1})},closeRoom:function(){if(this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.stop(),this.args.action=5,0===this.startTime&&(this.args.action=1),0!==this.startTime){var e=(new Date).getTime();this.args.duration=Math.round((e-this.startTime)/1e3),this.startTime=0}var t=JSON.stringify(this.args),s=this.to===this.$store.getters.myInfo.userID?this.from:this.to,o=wx.$app.createCustomMessage({to:s,conversationType:TYPES.CONV_C2C,payload:{data:t,description:"",extension:""}});this.$store.commit("sendMessage",o),wx.$app.sendMessage(o),clearTimeout(this.timeoutId)},timeout:function(){this.args.action=3;var e=JSON.stringify(this.args),t=wx.$app.createCustomMessage({to:this.to,conversationType:TYPES.CONV_C2C,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),wx.navigateBack({delta:1})},receive:function(){this.args.action=4;var e=JSON.stringify(this.args);this.startTime=(new Date).getTime();var t=wx.$app.createCustomMessage({to:this.from,conversationType:TYPES.CONV_C2C,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),clearTimeout(this.timeoutId),this.isCalling=!0,this.isPending=!1,this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.start()},onCall:function(){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.start()},refuse:function(){this.args.action=2;var e=JSON.stringify(this.args),t=wx.$app.createCustomMessage({to:this.from,conversationType:TYPES.CONV_C2C,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",t),this.$store.commit("setCalling",!1),wx.$app.sendMessage(t),clearTimeout(this.timeoutId)},alreadyCalling:function(e){var t=JSON.parse(e.payload.data);t.action=6;var s=wx.$app.createCustomMessage({to:e.from,conversationType:TYPES.CONV_C2C,payload:{data:JSON.stringify(t),description:"",extension:""}});this.$store.commit("sendMessage",s),wx.$app.sendMessage(s)},microphone:function(){this.muted=!this.muted},monitor:function(){this.webrtcroomComponent=this.$mp.page.selectComponent("#webrtcroom"),this.webrtcroomComponent.switchCamera()}},i=s,_possibleConstructorReturn(o,i)}return _inherits(t,e),_createClass(t,[{key:"onShow",value:function(){var e=this,t=(0,_GenerateTestUserSig.genTestUserSig)(this.userID);this.userSig=t.userSig,this.sdkAppID=t.sdkappid,this.isCalling=!1,this.isPending=!0,this.userID===this.from&&(this.timeoutId=setTimeout(function(){e.timeout()},6e4)),wx.setKeepScreenOn({keepScreenOn:!0}),this.$store.commit("setCalling",!0)}},{key:"onUnload",value:function(){this.refuseFlag||this.closeFlag||(this.isCalling?this.closeRoom():"call"===this.type?this.closeRoom():this.refuse()),this.refuseFlag=!1,this.closeFlag=!1,this.isCalling=!1,this.isPending=!1,clearTimeout(this.timeoutId),this.$store.commit("setCalling",!1)}},{key:"onHide",value:function(){this.isCalling=!1,this.isPending=!1,clearTimeout(this.timeoutId),this.closeRoom(),this.$store.commit("setCalling",!1),this.$bus.$off("onCall"),this.$bus.$off("isCalling"),this.$bus.$off("onClose"),this.$bus.$off("onRefuse"),this.$bus.$off("onBusy")}},{key:"onLoad",value:function(e){console.log(e),this.args=JSON.parse(e.args),this.userID=wx.getStorageSync("rendaUid")||this.$parent.globalData.uid,this.from=e.from,this.to=e.to,this.type=this.userID===this.from?"call":"onCall",this.roomID=this.args.room_id}},{key:"destory",value:function(){}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(call,"pages/message/call"));