"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_class,_temp2,_initialiseProps,_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_http=require("./../../http.js"),_moment=require("./../../npm/moment/moment.js"),_moment2=_interopRequireDefault(_moment),_util=require("./../../util.js"),_actionSheet=require("./../../components/actionSheet.js"),_actionSheet2=_interopRequireDefault(_actionSheet),_jobList=require("./../../components/jobList.js"),_jobList2=_interopRequireDefault(_jobList),_pdfView=require("./../../components/pdfView.js"),_pdfView2=_interopRequireDefault(_pdfView),_mlvbliveroomcore=require("./../../lib/mlvbliveroomcore.js"),lectureDetail=(_temp2=_class=function(e){function t(){var e,o,i,n;_classCallCheck(this,t);for(var a=arguments.length,s=Array(a),r=0;r<a;r++)s[r]=arguments[r];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),_initialiseProps.call(i),n=o,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"start",value:function(){this.component=this.$wxpage.selectComponent("#id_liveroom"),this.component.start(),this.createTask()}},{key:"onShareAppMessage",value:function(e){var t="/pages/lecture/detail?query="+this.id+"&roomID="+this.roomID+"&roomName="+this.roomName+"&userName="+this.options.userName+"&isShare=true";return{title:"邀请观看宣讲会",imageUrl:(0,_util.getImgUrl)("/uploads/images/zb.png"),path:t}}},{key:"_initIM",value:function(){wx.$app.off(this.TIM.EVENT.MESSAGE_RECEIVED,this._onIMMessageReceived),wx.$app.on(this.TIM.EVENT.MESSAGE_RECEIVED,this._onIMMessageReceived,this)}},{key:"_onIMMessageReceived",value:function(e){this.getGroupMessage()}},{key:"videoInit",value:function(){var e=this,t=wx.getStorageSync("userSig"),o=wx.getStorageSync("wxInfo")?JSON.parse(wx.getStorageSync("wxInfo")):{},i={sdkAppID:1400335565,userID:this.uid+"",userSig:t,userName:o.nick,userAvatar:o.avatar};(0,_mlvbliveroomcore.login)({data:i,success:function(t){e.firstshow=!1,e.isGetLoginInfo=!0,e.$apply()},fail:function(t){e.isGetLoginInfo=!1,e.$apply(),wx.showModal({title:"提示",content:t.errMsg,showCancel:!1,complete:function(){wx.navigateBack({})}})}})}},{key:"onLoad",value:function(e){this.id=e.query,this.uid=wx.getStorageSync("rendaUid"),this.rendaUserType=wx.getStorageSync("rendaUserType"),console.log(e),console.log("开始"),this.options=e,this.roomName=e.roomName,2==this.rendaUserType&&(this.roomID=e.roomID),this.$apply()}},{key:"onShow",value:function(){var e=this;wx.onNetworkStatusChange(function(t){e.networkType=t.networkType,e.$apply()}),wx.getNetworkType({success:function(t){e.networkType=t.networkType,e.$apply()}}),this.getLectureDetail(this.id),this.videoInit()}},{key:"onReady",value:function(){wx.setNavigationBarTitle({title:this.roomName})}},{key:"overVideo",value:function(){var e=this,t={uid:this.uid,id:this.id};(0,_http.$http)("/homepresentation/endPreachInfo",t).then(function(t){e.component=e.$wxpage.selectComponent("#id_liveroom"),e.component.stop(),(0,_util.wxToast)("宣讲结束"),wx.navigateBack({delta:1})})}},{key:"overTask",value:function(){var e={StreamName:"rendalive_"+this.id,TaskId:this.TaskId};(0,_http.$http)("/livebroadcast/stopLiveRecord",e).then(function(e){e.data?((0,_util.wxToast)("宣讲结束"),wx.navigateBack({delta:1})):(0,_util.wxToast)("推出宣讲失败")})}},{key:"createTask",value:function(){var e=this,t={StreamName:"rendalive_"+this.id,AppName:"live",RecordType:"video",FileFormat:"mp4"};(0,_http.$http)("/livebroadcast/createLiveRecord",t).then(function(t){e.TaskId=t.data.TaskId})}},{key:"getGroupMessage",value:function(){var e=this;wx.$app.getGroupMemberList({groupID:this.roomID,count:30,offset:0}).then(function(t){var o=t.data.memberList;e.getMessage(o)})}},{key:"getMessage",value:function(e){var t=this;wx.$app.getConversationList().then(function(o){var i=t.changeList(o.data.conversationList),n=[];i.forEach(function(t){e.forEach(function(e){e.userID==t.fromAccount&&n.push({text:t.text,nick:e.nick,avatar:e.avatar})})}),t.num=t.num+1,t.messageList=t.messageList.concat(n),t.message="",t.$apply()})}},{key:"changeList",value:function(e){var t=[];return e.forEach(function(e){var o=e.type,i=e.lastMessage;if("GROUP"==o){var n={};n=Object.assign({text:i.messageForShow,fromAccount:i.fromAccount}),t.push(n)}}),t}},{key:"sendMessage",value:function(){var e=this,t=this.roomID,o=wx.$app.createTextMessage({to:t,conversationType:this.TIM.TYPES.CONV_GROUP,payload:{text:this.message}});wx.$app.sendMessage(o).then(function(t){e.getGroupMessage()}).catch(function(e){console.warn("sendMessage error:",e)})}},{key:"createRoomId",value:function(e,t){var o=this,i={uid:this.uid,id:this.id,roomNum:e,pushUrl:t};(0,_http.$http)("/alecture/upRoomNum",i).then(function(t){o.roomID=e,o.$apply()}).catch(function(e){})}},{key:"bindrefresherrefresh",value:function(){this.getLectureDetail(this.id)}},{key:"getLectureDetail",value:function(e){var t=this,o={uid:this.uid,id:e};(0,_http.$http)("/Homepresentation/getAlectureInfo",o).then(function(e){t.getLectureInfo(e.data)})}},{key:"getLectureInfo",value:function(e){this.lectureInfo=e,this.lectureInfo.starttime=(0,_util.handleTime)(e.starttime),this.com_id=e.com_id,this.com_uid=e.com_uid,this.$apply()}}]),t}(_wepy2.default.page),_initialiseProps=function(){var e=this;this.$repeat={},this.$props={actionSheet:{"v-bind:isScaleModal.sync":"isScaleModal","v-bind:text.sync":"text","v-bind:okText.sync":"okText",bindhandleClose:"handleClose",bindhandleOk:"handleOk"},pdfView:{bindapplyResume:"applyResume","xmlns:v-bind":"","v-bind:lectureInfo.sync":"lectureInfo","v-bind:overBtnShow.sync":"overBtnShow"}},this.$events={},this.components={jobLectureList:_jobList2.default,actionSheet:_actionSheet2.default,pdfView:_pdfView2.default},this.data=_defineProperty({isScaleModal:!0,TIM:null,message:"",rendaUserType:0,isShow:!0,show:!1,lectureInfo:{},id:"",uid:"",com_id:"",com_uid:"",flag:!0,addBtn:!0,networkType:"",autoplay:!1,showPalyBtn:!0,userName:"",roomID:"",roomName:"",pureAudio:!1,role:"",showLiveRoom:!1,rooms:[],comment:[],linked:!1,debug:!1,frontCamera:!0,inputMsg:[],muted:!1,toview:"",beauty:5,shouldExit:!1,phoneNum:"",headerHeight:40,statusBarHeight:30,options:{},roomList:[],overBtnShow:!1,text:"",okText:"",messageList:[],animationData:{},timer:null,num:-1,TaskId:"",isFull:!1,destroyRoom:!1,isGetLoginInfo:!1,firstshow:!0,userAvatar:""},"userName",""),this.config={enablePullDownRefresh:!0,pageOrientation:"auto",usingComponents:{"mlvb-live-room":"/components/mlvb-live-room/mlvbliveroomview"}},this.events={handleClose:function(){e.isScaleModal=!e.isScaleModal,e.$apply()},handleOk:function(){e.isScaleModal=!e.isScaleModal,e.$apply(),2==e.rendaUserType?wx.getStorageSync("rendaPerfect")?(e.component=e.$wxpage.selectComponent("#id_liveroom"),e.component.stop(),e.overBtnShow=!1,e.$apply()):(0,_util.wxNavigateTo)("/pages/my/resume"):(e.destroyRoom=!0,e.$apply(),e.overVideo())},applyResume:function(e){var t=this;if(wx.getStorageSync("rendaPerfect")){var o={uid:this.uid,job_id:e.id,jf_id:this.id,type:2};(0,_http.$http)("/personaljob/addapplyJob",o).then(function(e){e.data?((0,_util.wxToast)("投递成功"),t.$broadcast("applyResumeOk")):(0,_util.wxToast)("投递失败")})}else this.isScaleModal=!this.isScaleModal,this.$apply()}},this.methods={setFull:function(){this.isFull=!this.isFull,this.$apply()},changeInput:function(e){if(!e.detail.value)return(0,_util.wxToast)("消息不能为空");this.message=e.detail.value,clearInterval(this.timer),this.sendMessage()},searchScrollLower:function(){this.$broadcast("searchScrollLower")},submit:function(){var e=this;if(!wx.getStorageSync("rendaPerfect"))return this.isScaleModal=!this.isScaleModal,this.okText="完善信息",this.text="个人信息不完整，请前往完善",void this.$apply();(0,_util.wxShowModal)("","确定报名该宣讲会吗?","确定").then(function(){var t={uid:e.uid,preachId:e.id};(0,_http.$http)("/homepresentation/preachEnroll",t).then(function(t){t.data?(e.lectureInfo.alectureApplyNum=1,e.$apply(),(0,_util.wxToast)("报名成功,请准时查看")):(0,_util.wxToast)("报名失败")})}).catch(function(){})},handleOver:function(){if(!this.roomID&&2==this.rendaUserType)return void(0,_util.wxToast)("宣讲会开始后，下拉刷新进入宣讲!");if(this.overBtnShow){if(5!=this.lectureInfo.status)return void(0,_util.wxToast)("宣讲未开始不能结束");this.text=1==this.rendaUserType?"结束宣讲 确认结束宣讲会吗？":"确认退出宣讲会宣讲吗？",this.okText="确认",this.isScaleModal=!this.isScaleModal,this.$apply()}else{if(5!=this.lectureInfo.status&&2==this.rendaUserType&&(0,_util.wxToast)("宣讲会未开始，到达时间后一大波观众观看哦!"),this.uid==this.com_uid||5==this.lectureInfo.status&&2==this.rendaUserType){(0,_util.wxToast)("宣讲中断，可以再次进入进行宣讲哦！");var e=this.options,t=void 0;e.roomID&&1==this.rendaUserType?(t="anchor",this.roomID=e.roomID):t="create"==e.type?"anchor":"audience",this.roomName=e.roomName,this.userName=e.userName,this.role=t,this.overBtnShow=!0,this.showLiveRoom=!0,"audience"==t?this.roomID=e.roomID:this.pureAudio=e.pureAudio,this.$apply()}this.start(),this.TIM=this.$parent.globalData.TIM,this._initIM()}},onRoomEvent:function(e){var t=this,o=e.detail;switch(o.tag){case"created":this.createRoomId(o.data.roomID,o.data.pushUrl);break;case"roomClosed":wx.showModal({content:"房间已解散",showCancel:!1,complete:function(){wx.navigateBack({delta:1})}});break;case"error":wx.showToast({title:o.detail+"["+o.code+"]",icon:"none",duration:1500}),5e3==o.code?(this.shouldExit=!0,t.$apply()):(console.error("收到error:",o),-9004!=o.code?setTimeout(function(){wx.navigateBack({delta:1})},1500):(t.linked=!1,t.phoneNum="",t.$apply()));break;case"recvTextMsg":console.log("收到消息:",e.detail.detail);var i=e.detail.detail;t.comment.push({content:i.message,name:i.userName,time:i.time}),t.comment=t.comment,t.toview="",t.toview="scroll-bottom",t.$apply();break;default:console.log("onRoomEvent default: ",e)}},onLinkClick:function(){var e=this;e.component&&e.component.requestJoinAnchor(),e.phoneNum="phone-1",e.$apply(),e.setInternal()},setInternal:function(){var e=this;setTimeout(function(){if(e.phoneNum){var t="";switch(e.phoneNum){case"phone-1":t="phone-2";break;case"phone-2":t="phone-3";break;case"phone-3":t="phone-1"}e.phoneNum=t,e.$apply(),e.setInternal()}},500)},showLog:function(){this.debug=!this.debug,this.$apply()},changeMute:function(){this.muted=!this.muted,this.$apply()},setBeauty:function(){this.beauty=5==this.beauty?0:5,this.$apply()},changeCamera:function(){this.component&&this.component.switchCamera(),this.frontCamera=!this.frontCamera,this.$apply()},bindInputMsg:function(e){this.inputMsg=e.detail.value},onBack:function(){this.overBtnShow=!0,this.text=1==this.rendaUserType?"结束宣讲 确认结束宣讲会吗？":"确认退出宣讲会宣讲吗？",this.okText="确认",this.isScaleModal=!this.isScaleModal,this.$apply()},againLoading:function(){"none"!=this.networkType?("wifi"!=this.networkType&&"none"!=this.networkType&&(0,_util.wxToast)("当前非Wi-Fi 播放，请注意流量消耗"),this.autoplay=!0,this.$apply):(0,_util.wxToast)("视频加载失败，请检查网络并重试")},bindplay:function(){"wifi"!=this.networkType&&"none"!=this.networkType?(0,_util.wxToast)("当前非Wi-Fi 播放，请注意流量消耗"):"none"==this.networkType?(0,_util.wxToast)("视频加载失败，请检查网络并重试"):(this.autoplay=!0,this.showPalyBtn=!1,this.$apply())},bindended:function(){this.autoplay=!1,this.showPalyBtn=!0,this.$apply()},back:function(){wx.navigateBack({delta:1})},collect:function(){var e=this,t={uid:this.uid,preachId:this.id},o=1==this.lectureInfo.collectNum?"取消收藏":"收藏",i=1==this.lectureInfo.collectNum?"/homepresentation/delAlectureCollect":"/homepresentation/collectPreach";console.log(t),(0,_http.$http)(i,t).then(function(t){console.log(t.data),console.log("收藏"),t.data?(e.lectureInfo.collectNum=1==e.lectureInfo.collectNum?0:1,e.$apply(),(0,_util.wxToast)(o+"成功")):(0,_util.wxToast)(o+"失败")})}}},_temp2);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(lectureDetail,"pages/lecture/detail"));